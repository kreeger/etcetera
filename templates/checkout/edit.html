{% extends "root.html" %}
{% load etcetera_tags %}

{% block title %}
   Editing Checkout #{{ object.id }}
{% endblock %}

{% block fullscript %}
   <script type="text/javascript" charset="utf-8">
      $(document).ready(function() {
         var display_error = function(msg, elem) {
           var msg_div = $('<div class="error_msg"><p>'+msg+'</p></div>');
           msg_div.insertAfter(elem).fadeIn('slow').animate({opacity: 1.0}, 20000).fadeOut('slow',function() { msg_div.remove(); });
         };
         
      	var add_eq = function() {
      		var barcode = $("#id_barcode").val()

      		if (barcode != "") {
      	    // post parameters in a js hash/dictionary
      	    var data = {barcode:barcode};
      	    // bundling the ajax arguments ahead of type
      	    var args = {
      			type:"POST",
      			url:"{% url checkout-addeq object.id %}",
      			data:data,
      			complete:done,
      		};
      		$.ajax(args)
      		}
      		else {
      			display_error("Requires value for barcode.", $(".new"));
      		}
      		// return false to override HTML button behavior
      		return false;
      	}

      	var done = function(res, status) {
      		if (status == "success") {
      			var json = eval(res.responseText);
      			var newTr = $('<tr class="datarow"><td><a href="../../../equipment/'+json[0].fields.id+'">'+json[0].fields.barcode+'</a></td><td><a href="../../../equipment/'+json[0].fields.id+'">'+json[0].fields.equipment_type+'</a></td><td><a href="../../../equipment/'+json[0].fields.id+'">'+json[0].fields.make+' '+json[0].fields.model+'</a></td><td><a href="../../../equipment/'+json[0].fields.id+'">'+json[0].fields.status+'</a></td><td><a href="../../../equipment/'+json[0].fields.id+'">'+json[0].fields.building+' '+json[0].fields.room+'</a></td><td>+ -</td></tr>');
      			$("#list").append(newTr);
      			$("#id_barcode").val("");
      	 	}
      		else {
      			display_error(res.responseText, $("id_barcode"));
      		}
      	}

      	$("#id_barcode").blur(add_eq);
      });
   </script>
{% endblock %}

{% block breadcrumb %}
   <a href="{% url etcetera-home %}">Home</a> &rsaquo;
   <a href="{% if object.completed %}#{% else %}{% url checkout-index %}{% endif %}">
      Checkout List
      {% if object.completed %} Archive{% endif %}
   </a> &rsaquo;
   <a href="{% url checkout-detail object.id %}">Checkout #{{ object.id }}</a> &rsaquo;
   Edit
{% endblock %}

{% block content %}
<div id="detail">
   <form action="" method="POST">
   <h1>
      {% if user.is_authenticated %}
         <span class="right">
            <input type="submit" name="save" value="save" id="save" />
         </span>
      {% endif %}
      {% if not object %}Adding a new {% endif %}
      Checkout{% if object %} #{{ object.id }}
         <span class="head">edit mode</span>
      {% endif %}
   </h1>
   
   <h2{% if form.completed.errors or form.checkout_type.errors or form.return_type.errors %} class="errorlist"{% endif %}>
      {% if object %}
         <span class="right">
            <span class="head">completed?</span> 
               {{ form.completed }} {{ form.completed.errors }}
         </span>
      {% endif %}
      Checkout type {{ form.checkout_type }} {{ form.checkout_type.errors }}<br />
      Return type {{ form.return_type }} {{ form.return_type.errors }}
   </h2>
   
   <div class="right">
      <h3>Contact information</h3>
      <table>
         <tr{% if form.phone.errors %} class="errorlist"{% endif %}>
            <td class="tablehead">{{ form.phone.label }}</td>
            <td>{{ form.phone }} {{ form.phone.errors }}</td>
         </tr>
         <tr{% if form.email.errors %} class="errorlist"{% endif %}>
            <td class="tablehead">{{ form.email.label }}</td>
            <td>{{ form.email }} {{ form.email.errors }}</td>
         </tr>
      </table>
   </div>
   
   <h3>Brief information</h3>
   <table>
      <tr{% if form.first_name.errors %} class="errorlist"{% endif %}>
         <td class="tablehead">{{ form.first_name.label }}</td>
         <td>{{ form.first_name }} {{ form.first_name.errors }}</td>
      </tr>
      <tr{% if form.last_name.errors %} class="errorlist"{% endif %}>
         <td class="tablehead">{{ form.last_name.label }}</td>
         <td>{{ form.last_name }} {{ form.last_name.errors }}</td>
      </tr>
      <tr{% if form.department.errors %} class="errorlist"{% endif %}>
         <td class="tablehead">{{ form.department.label }}</td>
         <td>{{ form.department }} {{ form.department.errors }}</td>
      </tr>
      {% if object %}
         <tr>
            <td class="tablehead">Department (user)</td>
            <td>{{ object.department_text }}</td>
         </tr>
      {% endif %}
      <tr{% if form.course.errors %} class="errorlist"{% endif %}>
         <td class="tablehead">{{ form.course.label }}</td>
         <td>{{ form.course }} {{ form.course.errors }}</td>
      </tr>
      <tr{% if form.building.errors %} class="errorlist"{% endif %}>
         <td class="tablehead">{{ form.building.label }}</td>
         <td>{{ form.building }} {{ form.building.errors }}</td>
      </tr>
      <tr{% if form.room.errors %} class="errorlist"{% endif %}>
         <td class="tablehead">{{ form.room.label }}</td>
         <td>{{ form.room }} {{ form.room.errors }}</td>
      </tr>
      <tr{% if form.returning_person.errors %} class="errorlist"{% endif %}>
         <td class="tablehead">{{ form.returning_person.label }}</td>
         <td>
            {{ form.returning_person }}
            {{ form.returning_person.errors }}
         </td>
      </tr>
      <tr{% if form.out_date.errors %} class="errorlist"{% endif %}>
         <td class="tablehead">{{ form.out_date.label }}</td>
         <td>{{ form.out_date }} {{ form.out_date.errors }}</td>
      </tr>
      <tr{% if form.return_date.errors %} class="errorlist"{% endif %}>
         <td class="tablehead">{{ form.return_date.label }}</td>
         <td>{{ form.return_date }} {{ form.return_date.errors }}</td>
      </tr>
   </table>
   
   <h3>{{ form.equipment_needed.label }}</h3>
   <p{% if form.equipment_needed.errors %} class="errorlist"{% endif %}>
      {{ form.equipment_needed }} {{ form.equipment_needed.errors }}
   </p>
   
   <h3>Personnel information</h3>
   <table>
      {% if object %}
         <tr>
            <td class="tablehead">Created by</td>
            <td>
               <a href="{% url etcetera-user object.creating_user.username %}">
                  {{ object.creating_user.get_full_name }}
               </a>
            </td>
         </tr>
      {% endif %}
      <tr{% if form.delivering_user.errors %} class="errorlist"{% endif %}>
         <td class="tablehead">{{ form.delivering_user.label }}</td>
         <td>{{ form.delivering_user }} {{ form.delivering_user.errors }}</td>
      </tr>
   </table>
   
   <h3>Add equipment by barcode</h3>
   {{ eqform.barcode }}
   <table id="list">
      <tr id="headerrow">
         <td>Barcode</td>
         <td>Type</td>
         <td>Make &amp; Model</td>
         <td>Status</td>
         <td>Location</td>
         <td>Operation</td>
      </tr>
      {% for item in object.equipment_list.all %}
         <tr class="datarow">
            <td>
               <a href="{% url equipment-detail item.id %}">
                  {{ item.barcode }}
               </a>
            </td>
            <td>
               <a href="{% url equipment-detail item.id %}">
                  {{ item.equipment_type.name }}
               </a>
            </td>
            <td>
               <a href="{% url equipment-detail item.id %}">
                  {{ item.make.name }} {{ item.model }}
               </a>
            </td>
            <td>
               <a href="{% url equipment-detail item.id %}">
                  {{ item.get_status_display }}
               </a>
            </td>
            <td>
               <a href="{% url equipment-detail item.id %}">
                  {{ item.building.abbreviation }} {{ item.room }}
               </a>
            </td>
            <td class="buttons">
               <a href="{% url checkout-remeq object.id item.id %}" class="remove" id="{{ item.id }}">&nbsp;</a>
            </td>
         </tr>
      {% endfor %}
   </table>
   
   <h3>{{ form.other_equipment.label }}</h3>
   <p{% if form.other_equipment.errors %} class="errorlist"{% endif %}>
      {{ form.other_equipment }}
      {{ form.other_equipment.errors }}
   </p>
   
   <h3>{{ form.software.label }}</h3>
   <p{% if form.software.errors %} class="errorlist"{% endif %}>
      {{ form.software }}
      {{ form.software.errors }}
   </p>
   </form>
</div>
{% endblock %}